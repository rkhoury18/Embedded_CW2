#include <Arduino.h>
#include <U8g2lib.h>

//Constants
  const uint32_t interval = 100; //Display update interval

//Pin definitions
  //Row select and enable
  const int RA0_PIN = D3;
  const int RA1_PIN = D6;
  const int RA2_PIN = D12;
  const int REN_PIN = A5;

  //Matrix input and output
  const int C0_PIN = A2;
  const int C1_PIN = D9;
  const int C2_PIN = A6;
  const int C3_PIN = D1;
  const int OUT_PIN = D11;

  //Audio analogue out
  const int OUTL_PIN = A4;
  const int OUTR_PIN = A3;

  //Joystick analogue in
  const int JOYY_PIN = A0;
  const int JOYX_PIN = A1;

  //Output multiplexer bits
  const int DEN_BIT = 3;
  const int DRST_BIT = 4;
  const int HKOW_BIT = 5;
  const int HKOE_BIT = 6;

  //Wave Selector code
  volatile int increase = 1;
  volatile int wave_select = 3;

  //Phase step sizes
  const uint32_t stepSizes [12] = {51076057, 54113197, 57330935, 60740010, 64351799, 68178356, 72232452, 76527617, 81078186, 85899346, 91007187, 96418756};
  const uint32_t sineTable [1024] = {2147483647, 2160660358, 2173836574, 2187011798, 2200185533, 2213357285, 2226526556, 2239692851, 2252855675, 2266014531, 2279168925, 2292318361, 2305462344, 2318600379, 2331731972, 2344856628, 2357973852, 2371083153, 2384184034, 2397276004, 2410358570, 2423431238, 2436493517, 2449544915, 2462584941, 2475613103, 2488628912, 2501631876, 2514621507, 2527597315, 2540558813, 2553505511, 2566436923, 2579352561, 2592251940, 2605134574, 2617999977, 2630847665, 2643677156, 2656487964, 2669279609, 2682051609, 2694803483, 2707534750, 2720244932, 2732933549, 2745600125, 2758244182, 2770865244, 2783462836, 2796036484, 2808585714, 2821110054, 2833609033, 2846082179, 2858529024, 2870949098, 2883341933, 2895707065, 2908044026, 2920352352, 2932631580, 2944881248, 2957100895, 2969290059, 2981448284, 2993575110, 3005670081, 3017732741, 3029762638, 3041759317, 3053722327, 3065651218, 3077545540, 3089404846, 3101228689, 3113016624, 3124768208, 3136482997, 3148160551, 3159800430, 3171402196, 3182965412, 3194489643, 3205974454, 3217419414, 3228824091, 3240188057, 3251510883, 3262792142, 3274031411, 3285228267, 3296382286, 3307493051, 3318560141, 3329583142, 3340561637, 3351495213, 3362383459, 3373225964, 3384022321, 3394772123, 3405474966, 3416130446, 3426738161, 3437297714, 3447808706, 3458270741, 3468683426, 3479046369, 3489359179, 3499621468, 3509832850, 3519992940, 3530101356, 3540157718, 3550161645, 3560112763, 3570010696, 3579855072, 3589645520, 3599381671, 3609063159, 3618689620, 3628260690, 3637776010, 3647235222, 3656637968, 3665983896, 3675272653, 3684503889, 3693677258, 3702792414, 3711849012, 3720846714, 3729785179, 3738664071, 3747483057, 3756241803, 3764939981, 3773577262, 3782153321, 3790667837, 3799120487, 3807510954, 3815838922, 3824104077, 3832306109, 3840444708, 3848519568, 3856530385, 3864476857, 3872358686, 3880175573, 3887927226, 3895613353, 3903233663, 3910787870, 3918275690, 3925696840, 3933051042, 3940338018, 3947557494, 3954709199, 3961792862, 3968808218, 3975755001, 3982632952, 3989441810, 3996181319, 4002851226, 4009451280, 4015981231, 4022440835, 4028829847, 4035148028, 4041395140, 4047570946, 4053675216, 4059707718, 4065668226, 4071556516, 4077372366, 4083115556, 4088785871, 4094383096, 4099907023, 4105357441, 4110734147, 4116036937, 4121265613, 4126419976, 4131499834, 4136504995, 4141435270, 4146290475, 4151070425, 4155774941, 4160403846, 4164956966, 4169434129, 4173835167, 4178159914, 4182408207, 4186579887, 4190674795, 4194692779, 4198633686, 4202497369, 4206283681, 4209992481, 4213623629, 4217176987, 4220652423, 4224049805, 4227369006, 4230609900, 4233772365, 4236856283, 4239861538, 4242788015, 4245635606, 4248404202, 4251093699, 4253703997, 4256234997, 4258686604, 4261058725, 4263351271, 4265564156, 4267697297, 4269750612, 4271724026, 4273617463, 4275430852, 4277164125, 4278817217, 4280390065, 4281882611, 4283294798, 4284626573, 4285877885, 4287048688, 4288138938, 4289148594, 4290077616, 4290925972, 4291693628, 4292380555, 4292986729, 4293512125, 4293956725, 4294320512, 4294603471, 4294805592, 4294926868, 4294967294, 4294926868, 4294805592, 4294603471, 4294320512, 4293956725, 4293512125, 4292986729, 4292380555, 4291693628, 4290925972, 4290077616, 4289148594, 4288138938, 4287048688, 4285877885, 4284626573, 4283294798, 4281882611, 4280390065, 4278817217, 4277164125, 4275430852, 4273617463, 4271724026, 4269750612, 4267697297, 4265564156, 4263351271, 4261058725, 4258686604, 4256234997, 4253703997, 4251093699, 4248404202, 4245635606, 4242788015, 4239861538, 4236856283, 4233772365, 4230609900, 4227369006, 4224049805, 4220652423, 4217176987, 4213623629, 4209992481, 4206283681, 4202497369, 4198633686, 4194692779, 4190674795, 4186579887, 4182408207, 4178159914, 4173835167, 4169434129, 4164956966, 4160403846, 4155774941, 4151070425, 4146290475, 4141435270, 4136504995, 4131499834, 4126419976, 4121265613, 4116036937, 4110734147, 4105357441, 4099907023, 4094383096, 4088785871, 4083115556, 4077372366, 4071556516, 4065668226, 4059707718, 4053675216, 4047570946, 4041395140, 4035148028, 4028829847, 4022440835, 4015981231, 4009451280, 4002851226, 3996181319, 3989441810, 3982632952, 3975755001, 3968808218, 3961792862, 3954709199, 3947557494, 3940338018, 3933051042, 3925696840, 3918275690, 3910787870, 3903233663, 3895613353, 3887927226, 3880175573, 3872358686, 3864476857, 3856530385, 3848519568, 3840444708, 3832306109, 3824104077, 3815838922, 3807510954, 3799120487, 3790667837, 3782153321, 3773577262, 3764939981, 3756241803, 3747483057, 3738664071, 3729785179, 3720846714, 3711849012, 3702792414, 3693677258, 3684503889, 3675272653, 3665983896, 3656637968, 3647235222, 3637776010, 3628260690, 3618689620, 3609063159, 3599381671, 3589645520, 3579855072, 3570010696, 3560112763, 3550161645, 3540157718, 3530101356, 3519992940, 3509832850, 3499621468, 3489359179, 3479046369, 3468683426, 3458270741, 3447808706, 3437297714, 3426738161, 3416130446, 3405474966, 3394772123, 3384022321, 3373225964, 3362383459, 3351495213, 3340561637, 3329583142, 3318560141, 3307493051, 3296382286, 3285228267, 3274031411, 3262792142, 3251510883, 3240188057, 3228824091, 3217419414, 3205974454, 3194489643, 3182965412, 3171402196, 3159800430, 3148160551, 3136482997, 3124768208, 3113016624, 3101228689, 3089404846, 3077545540, 3065651218, 3053722327, 3041759317, 3029762638, 3017732741, 3005670081, 2993575110, 2981448284, 2969290059, 2957100895, 2944881248, 2932631580, 2920352352, 2908044026, 2895707065, 2883341933, 2870949098, 2858529024, 2846082179, 2833609033, 2821110054, 2808585714, 2796036484, 2783462836, 2770865244, 2758244182, 2745600125, 2732933549, 2720244932, 2707534750, 2694803483, 2682051609, 2669279609, 2656487964, 2643677156, 2630847665, 2617999977, 2605134574, 2592251940, 2579352561, 2566436923, 2553505511, 2540558813, 2527597315, 2514621507, 2501631876, 2488628912, 2475613103, 2462584941, 2449544915, 2436493517, 2423431238, 2410358570, 2397276004, 2384184034, 2371083153, 2357973852, 2344856628, 2331731972, 2318600379, 2305462344, 2292318361, 2279168925, 2266014531, 2252855675, 2239692851, 2226526556, 2213357285, 2200185533, 2187011798, 2173836574, 2160660358, 2147483647, 2134306936, 2121130720, 2107955496, 2094781761, 2081610009, 2068440738, 2055274443, 2042111619, 2028952763, 2015798369, 2002648933, 1989504950, 1976366915, 1963235322, 1950110666, 1936993442, 1923884141, 1910783260, 1897691290, 1884608724, 1871536056, 1858473777, 1845422379, 1832382353, 1819354191, 1806338382, 1793335418, 1780345787, 1767369979, 1754408481, 1741461783, 1728530371, 1715614733, 1702715354, 1689832720, 1676967317, 1664119629, 1651290138, 1638479330, 1625687685, 1612915685, 1600163811, 1587432544, 1574722362, 1562033745, 1549367169, 1536723112, 1524102050, 1511504458, 1498930810, 1486381580, 1473857240, 1461358261, 1448885115, 1436438270, 1424018196, 1411625361, 1399260229, 1386923268, 1374614942, 1362335714, 1350086046, 1337866399, 1325677235, 1313519010, 1301392184, 1289297213, 1277234553, 1265204656, 1253207977, 1241244967, 1229316076, 1217421754, 1205562448, 1193738605, 1181950670, 1170199086, 1158484297, 1146806743, 1135166864, 1123565098, 1112001882, 1100477651, 1088992840, 1077547880, 1066143203, 1054779237, 1043456411, 1032175152, 1020935883, 1009739027, 998585008, 987474243, 976407153, 965384152, 954405657, 943472081, 932583835, 921741330, 910944973, 900195171, 889492328, 878836848, 868229133, 857669580, 847158588, 836696553, 826283868, 815920925, 805608115, 795345826, 785134444, 774974354, 764865938, 754809576, 744805649, 734854531, 724956598, 715112222, 705321774, 695585623, 685904135, 676277674, 666706604, 657191284, 647732072, 638329326, 628983398, 619694641, 610463405, 601290036, 592174880, 583118282, 574120580, 565182115, 556303223, 547484237, 538725491, 530027313, 521390032, 512813973, 504299457, 495846807, 487456340, 479128372, 470863217, 462661185, 454522586, 446447726, 438436909, 430490437, 422608608, 414791721, 407040068, 399353941, 391733631, 384179424, 376691604, 369270454, 361916252, 354629276, 347409800, 340258095, 333174432, 326159076, 319212293, 312334342, 305525484, 298785975, 292116068, 285516014, 278986063, 272526459, 266137447, 259819266, 253572154, 247396348, 241292078, 235259576, 229299068, 223410778, 217594928, 211851738, 206181423, 200584198, 195060271, 189609853, 184233147, 178930357, 173701681, 168547318, 163467460, 158462299, 153532024, 148676819, 143896869, 139192353, 134563448, 130010328, 125533165, 121132127, 116807380, 112559087, 108387407, 104292499, 100274515, 96333608, 92469925, 88683613, 84974813, 81343665, 77790307, 74314871, 70917489, 67598288, 64357394, 61194929, 58111011, 55105756, 52179279, 49331688, 46563092, 43873595, 41263297, 38732297, 36280690, 33908569, 31616023, 29403138, 27269997, 25216682, 23243268, 21349831, 19536442, 17803169, 16150077, 14577229, 13084683, 11672496, 10340721, 9089409, 7918606, 6828356, 5818700, 4889678, 4041322, 3273666, 2586739, 1980565, 1455169, 1010569, 646782, 363823, 161702, 40426, 0, 40426, 161702, 363823, 646782, 1010569, 1455169, 1980565, 2586739, 3273666, 4041322, 4889678, 5818700, 6828356, 7918606, 9089409, 10340721, 11672496, 13084683, 14577229, 16150077, 17803169, 19536442, 21349831, 23243268, 25216682, 27269997, 29403138, 31616023, 33908569, 36280690, 38732297, 41263297, 43873595, 46563092, 49331688, 52179279, 55105756, 58111011, 61194929, 64357394, 67598288, 70917489, 74314871, 77790307, 81343665, 84974813, 88683613, 92469925, 96333608, 100274515, 104292499, 108387407, 112559087, 116807380, 121132127, 125533165, 130010328, 134563448, 139192353, 143896869, 148676819, 153532024, 158462299, 163467460, 168547318, 173701681, 178930357, 184233147, 189609853, 195060271, 200584198, 206181423, 211851738, 217594928, 223410778, 229299068, 235259576, 241292078, 247396348, 253572154, 259819266, 266137447, 272526459, 278986063, 285516014, 292116068, 298785975, 305525484, 312334342, 319212293, 326159076, 333174432, 340258095, 347409800, 354629276, 361916252, 369270454, 376691604, 384179424, 391733631, 399353941, 407040068, 414791721, 422608608, 430490437, 438436909, 446447726, 454522586, 462661185, 470863217, 479128372, 487456340, 495846807, 504299457, 512813973, 521390032, 530027313, 538725491, 547484237, 556303223, 565182115, 574120580, 583118282, 592174880, 601290036, 610463405, 619694641, 628983398, 638329326, 647732072, 657191284, 666706604, 676277674, 685904135, 695585623, 705321774, 715112222, 724956598, 734854531, 744805649, 754809576, 764865938, 774974354, 785134444, 795345826, 805608115, 815920925, 826283868, 836696553, 847158588, 857669580, 868229133, 878836848, 889492328, 900195171, 910944973, 921741330, 932583835, 943472081, 954405657, 965384152, 976407153, 987474243, 998585008, 1009739027, 1020935883, 1032175152, 1043456411, 1054779237, 1066143203, 1077547880, 1088992840, 1100477651, 1112001882, 1123565098, 1135166864, 1146806743, 1158484297, 1170199086, 1181950670, 1193738605, 1205562448, 1217421754, 1229316076, 1241244967, 1253207977, 1265204656, 1277234553, 1289297213, 1301392184, 1313519010, 1325677235, 1337866399, 1350086046, 1362335714, 1374614942, 1386923268, 1399260229, 1411625361, 1424018196, 1436438270, 1448885115, 1461358261, 1473857240, 1486381580, 1498930810, 1511504458, 1524102050, 1536723112, 1549367169, 1562033745, 1574722362, 1587432544, 1600163811, 1612915685, 1625687685, 1638479330, 1651290138, 1664119629, 1676967317, 1689832720, 1702715354, 1715614733, 1728530371, 1741461783, 1754408481, 1767369979, 1780345787, 1793335418, 1806338382, 1819354191, 1832382353, 1845422379, 1858473777, 1871536056, 1884608724, 1897691290, 1910783260, 1923884141, 1936993442, 1950110666, 1963235322, 1976366915, 1989504950, 2002648933, 2015798369, 2028952763, 2042111619, 2055274443, 2068440738, 2081610009, 2094781761, 2107955496, 2121130720, 2134306936};


  const uint32_t LFOTable[4096] = {16777216, 16802952, 16828688, 16854424, 16880159, 16905894, 16931629, 16957364, 16983098, 17008832, 17034565, 17060298, 17086030, 17111761, 17137491, 17163221, 17188949, 17214677, 17240404, 17266129, 17291854, 17317577, 17343299, 17369020, 17394739, 17420456, 17446173, 17471887, 17497600, 17523312, 17549021, 17574729, 17600435, 17626139, 17651841, 17677541, 17703239, 17728934, 17754627, 17780319, 17806007, 17831694, 17857377, 17883059, 17908737, 17934413, 17960086, 17985757, 18011425, 18037089, 18062751, 18088410, 18114065, 18139718, 18165367, 18191013, 18216656, 18242295, 18267931, 18293564, 18319192, 18344818, 18370439, 18396057, 18421671, 18447281, 18472887, 18498489, 18524087, 18549681, 18575271, 18600856, 18626438, 18652015, 18677587, 18703155, 18728719, 18754278, 18779832, 18805382, 18830926, 18856466, 18882001, 18907531, 18933057, 18958577, 18984091, 19009601, 19035106, 19060605, 19086099, 19111587, 19137070, 19162547, 19188019, 19213485, 19238945, 19264399, 19289848, 19315291, 19340727, 19366158, 19391583, 19417001, 19442413, 19467819, 19493219, 19518612, 19543999, 19569379, 19594753, 19620120, 19645481, 19670834, 19696181, 19721521, 19746854, 19772180, 19797499, 19822811, 19848116, 19873413, 19898703, 19923986, 19949262, 19974530, 19999790, 20025043, 20050288, 20075526, 20100756, 20125978, 20151192, 20176398, 20201596, 20226786, 20251968, 20277142, 20302308, 20327465, 20352614, 20377754, 20402886, 20428010, 20453125, 20478231, 20503329, 20528417, 20553497, 20578568, 20603631, 20628684, 20653728, 20678763, 20703788, 20728805, 20753812, 20778810, 20803799, 20828778, 20853747, 20878707, 20903657, 20928597, 20953528, 20978449, 21003360, 21028261, 21053152, 21078033, 21102904, 21127765, 21152615, 21177455, 21202285, 21227105, 21251914, 21276712, 21301500, 21326277, 21351043, 21375799, 21400544, 21425278, 21450001, 21474713, 21499414, 21524104, 21548783, 21573450, 21598106, 21622751, 21647385, 21672007, 21696617, 21721216, 21745803, 21770379, 21794943, 21819495, 21844035, 21868563, 21893080, 21917584, 21942076, 21966556, 21991024, 22015479, 22039922, 22064353, 22088771, 22113177, 22137571, 22161951, 22186319, 22210675, 22235017, 22259347, 22283663, 22307967, 22332258, 22356536, 22380800, 22405052, 22429290, 22453515, 22477726, 22501924, 22526109, 22550280, 22574437, 22598581, 22622711, 22646828, 22670930, 22695019, 22719094, 22743155, 22767202, 22791234, 22815253, 22839257, 22863247, 22887223, 22911184, 22935131, 22959064, 22982981, 23006885, 23030773, 23054647, 23078506, 23102351, 23126180, 23149995, 23173794, 23197579, 23221348, 23245102, 23268841, 23292565, 23316273, 23339966, 23363644, 23387306, 23410952, 23434583, 23458198, 23481798, 23505381, 23528949, 23552501, 23576037, 23599557, 23623061, 23646549, 23670021, 23693476, 23716915, 23740338, 23763745, 23787135, 23810508, 23833865, 23857206, 23880529, 23903836, 23927127, 23950400, 23973657, 23996896, 24020119, 24043325, 24066513, 24089684, 24112839, 24135975, 24159095, 24182197, 24205282, 24228349, 24251399, 24274431, 24297446, 24320442, 24343421, 24366383, 24389326, 24412252, 24435159, 24458049, 24480920, 24503773, 24526609, 24549425, 24572224, 24595004, 24617766, 24640510, 24663235, 24685941, 24708629, 24731298, 24753948, 24776580, 24799192, 24821786, 24844361, 24866917, 24889454, 24911972, 24934471, 24956950, 24979411, 25001852, 25024273, 25046675, 25069058, 25091421, 25113765, 25136089, 25158394, 25180678, 25202943, 25225188, 25247413, 25269619, 25291804, 25313969, 25336114, 25358239, 25380344, 25402429, 25424493, 25446537, 25468561, 25490564, 25512546, 25534508, 25556450, 25578370, 25600270, 25622150, 25644008, 25665846, 25687663, 25709458, 25731233, 25752987, 25774719, 25796430, 25818121, 25839789, 25861437, 25883063, 25904668, 25926251, 25947813, 25969353, 25990871, 26012368, 26033843, 26055297, 26076728, 26098138, 26119525, 26140891, 26162235, 26183556, 26204856, 26226133, 26247388, 26268621, 26289831, 26311019, 26332185, 26353328, 26374448, 26395546, 26416622, 26437674, 26458704, 26479711, 26500696, 26521657, 26542596, 26563511, 26584404, 26605273, 26626119, 26646943, 26667742, 26688519, 26709272, 26730002, 26750709, 26771392, 26792051, 26812687, 26833300, 26853888, 26874453, 26894995, 26915512, 26936006, 26956475, 26976921, 26997343, 27017740, 27038114, 27058463, 27078788, 27099089, 27119366, 27139618, 27159846, 27180050, 27200229, 27220383, 27240513, 27260619, 27280699, 27300755, 27320786, 27340793, 27360774, 27380731, 27400663, 27420569, 27440451, 27460307, 27480139, 27499945, 27519726, 27539482, 27559212, 27578917, 27598596, 27618251, 27637879, 27657482, 27677060, 27696611, 27716138, 27735638, 27755112, 27774561, 27793984, 27813381, 27832752, 27852097, 27871416, 27890709, 27909975, 27929216, 27948430, 27967618, 27986779, 28005915, 28025023, 28044106, 28063161, 28082191, 28101193, 28120169, 28139119, 28158041, 28176937, 28195806, 28214648, 28233463, 28252251, 28271013, 28289747, 28308454, 28327134, 28345787, 28364412, 28383010, 28401581, 28420125, 28438641, 28457130, 28475591, 28494025, 28512431, 28530810, 28549161, 28567484, 28585780, 28604047, 28622287, 28640499, 28658683, 28676839, 28694968, 28713068, 28731140, 28749183, 28767199, 28785187, 28803146, 28821077, 28838979, 28856854, 28874699, 28892517, 28910305, 28928066, 28945797, 28963500, 28981175, 28998820, 29016437, 29034025, 29051585, 29069115, 29086616, 29104089, 29121532, 29138947, 29156332, 29173688, 29191015, 29208313, 29225582, 29242821, 29260031, 29277211, 29294363, 29311484, 29328576, 29345639, 29362672, 29379676, 29396649, 29413594, 29430508, 29447393, 29464247, 29481072, 29497867, 29514633, 29531368, 29548073, 29564748, 29581393, 29598008, 29614592, 29631147, 29647671, 29664165, 29680629, 29697062, 29713465, 29729837, 29746179, 29762491, 29778772, 29795022, 29811242, 29827431, 29843589, 29859716, 29875813, 29891879, 29907914, 29923918, 29939891, 29955834, 29971745, 29987625, 30003474, 30019292, 30035079, 30050835, 30066559, 30082252, 30097914, 30113545, 30129144, 30144711, 30160248, 30175752, 30191225, 30206667, 30222077, 30237456, 30252802, 30268117, 30283401, 30298652, 30313872, 30329060, 30344215, 30359339, 30374431, 30389492, 30404520, 30419515, 30434479, 30449411, 30464311, 30479178, 30494013, 30508816, 30523586, 30538324, 30553030, 30567704, 30582345, 30596953, 30611529, 30626072, 30640583, 30655061, 30669507, 30683919, 30698299, 30712647, 30726961, 30741243, 30755492, 30769708, 30783891, 30798041, 30812158, 30826242, 30840293, 30854311, 30868296, 30882247, 30896166, 30910051, 30923903, 30937721, 30951507, 30965259, 30978977, 30992662, 31006314, 31019932, 31033517, 31047068, 31060586, 31074070, 31087520, 31100937, 31114320, 31127669, 31140985, 31154266, 31167514, 31180728, 31193908, 31207054, 31220167, 31233245, 31246289, 31259299, 31272275, 31285217, 31298125, 31310999, 31323838, 31336643, 31349414, 31362151, 31374853, 31387521, 31400155, 31412754, 31425319, 31437849, 31450345, 31462806, 31475233, 31487625, 31499983, 31512306, 31524594, 31536848, 31549066, 31561250, 31573400, 31585514, 31597594, 31609638, 31621648, 31633623, 31645563, 31657468, 31669338, 31681173, 31692972, 31704737, 31716467, 31728161, 31739820, 31751444, 31763033, 31774587, 31786105, 31797588, 31809035, 31820448, 31831824, 31843166, 31854472, 31865742, 31876977, 31888176, 31899340, 31910469, 31921561, 31932618, 31943640, 31954625, 31965575, 31976489, 31987368, 31998211, 32009017, 32019788, 32030524, 32041223, 32051886, 32062514, 32073105, 32083660, 32094180, 32104663, 32115111, 32125522, 32135897, 32146236, 32156539, 32166805, 32177036, 32187230, 32197388, 32207509, 32217595, 32227643, 32237656, 32247632, 32257572, 32267476, 32277342, 32287173, 32296967, 32306724, 32316445, 32326130, 32335777, 32345389, 32354963, 32364501, 32374002, 32383467, 32392894, 32402285, 32411640, 32420957, 32430238, 32439482, 32448688, 32457859, 32466992, 32476088, 32485147, 32494170, 32503155, 32512103, 32521015, 32529889, 32538726, 32547526, 32556289, 32565015, 32573704, 32582356, 32590970, 32599547, 32608087, 32616590, 32625055, 32633484, 32641874, 32650228, 32658544, 32666823, 32675064, 32683268, 32691435, 32699564, 32707655, 32715710, 32723726, 32731705, 32739647, 32747551, 32755417, 32763246, 32771037, 32778791, 32786507, 32794185, 32801826, 32809429, 32816994, 32824521, 32832011, 32839463, 32846877, 32854253, 32861591, 32868892, 32876155, 32883379, 32890566, 32897715, 32904826, 32911899, 32918935, 32925932, 32932891, 32939812, 32946695, 32953540, 32960347, 32967116, 32973847, 32980540, 32987194, 32993811, 33000389, 33006929, 33013431, 33019895, 33026320, 33032708, 33039057, 33045367, 33051640, 33057874, 33064070, 33070227, 33076347, 33082427, 33088470, 33094474, 33100440, 33106367, 33112256, 33118106, 33123918, 33129692, 33135427, 33141123, 33146781, 33152401, 33157982, 33163524, 33169028, 33174493, 33179920, 33185308, 33190658, 33195969, 33201241, 33206475, 33211670, 33216826, 33221943, 33227022, 33232062, 33237064, 33242027, 33246951, 33251836, 33256682, 33261490, 33266259, 33270989, 33275680, 33280333, 33284947, 33289521, 33294057, 33298554, 33303013, 33307432, 33311812, 33316154, 33320456, 33324720, 33328945, 33333130, 33337277, 33341385, 33345454, 33349484, 33353475, 33357427, 33361340, 33365213, 33369048, 33372844, 33376601, 33380318, 33383997, 33387636, 33391237, 33394798, 33398320, 33401804, 33405248, 33408652, 33412018, 33415345, 33418632, 33421880, 33425090, 33428260, 33431390, 33434482, 33437534, 33440547, 33443521, 33446456, 33449352, 33452208, 33455025, 33457803, 33460541, 33463241, 33465901, 33468521, 33471103, 33473645, 33476148, 33478612, 33481036, 33483421, 33485767, 33488073, 33490340, 33492568, 33494756, 33496905, 33499015, 33501085, 33503116, 33505108, 33507060, 33508973, 33510847, 33512681, 33514476, 33516231, 33517947, 33519624, 33521261, 33522859, 33524418, 33525937, 33527416, 33528856, 33530257, 33531619, 33532941, 33534223, 33535466, 33536670, 33537834, 33538959, 33540044, 33541090, 33542097, 33543063, 33543991, 33544879, 33545728, 33546537, 33547307, 33548037, 33548728, 33549379, 33549991, 33550563, 33551096, 33551590, 33552044, 33552458, 33552833, 33553169, 33553465, 33553721, 33553939, 33554116, 33554254, 33554353, 33554412, 33554432, 33554412, 33554353, 33554254, 33554116, 33553939, 33553721, 33553465, 33553169, 33552833, 33552458, 33552044, 33551590, 33551096, 33550563, 33549991, 33549379, 33548728, 33548037, 33547307, 33546537, 33545728, 33544879, 33543991, 33543063, 33542097, 33541090, 33540044, 33538959, 33537834, 33536670, 33535466, 33534223, 33532941, 33531619, 33530257, 33528856, 33527416, 33525937, 33524418, 33522859, 33521261, 33519624, 33517947, 33516231, 33514476, 33512681, 33510847, 33508973, 33507060, 33505108, 33503116, 33501085, 33499015, 33496905, 33494756, 33492568, 33490340, 33488073, 33485767, 33483421, 33481036, 33478612, 33476148, 33473645, 33471103, 33468521, 33465901, 33463241, 33460541, 33457803, 33455025, 33452208, 33449352, 33446456, 33443521, 33440547, 33437534, 33434482, 33431390, 33428260, 33425090, 33421880, 33418632, 33415345, 33412018, 33408652, 33405248, 33401804, 33398320, 33394798, 33391237, 33387636, 33383997, 33380318, 33376601, 33372844, 33369048, 33365213, 33361340, 33357427, 33353475, 33349484, 33345454, 33341385, 33337277, 33333130, 33328945, 33324720, 33320456, 33316154, 33311812, 33307432, 33303013, 33298554, 33294057, 33289521, 33284947, 33280333, 33275680, 33270989, 33266259, 33261490, 33256682, 33251836, 33246951, 33242027, 33237064, 33232062, 33227022, 33221943, 33216826, 33211670, 33206475, 33201241, 33195969, 33190658, 33185308, 33179920, 33174493, 33169028, 33163524, 33157982, 33152401, 33146781, 33141123, 33135427, 33129692, 33123918, 33118106, 33112256, 33106367, 33100440, 33094474, 33088470, 33082427, 33076347, 33070227, 33064070, 33057874, 33051640, 33045367, 33039057, 33032708, 33026320, 33019895, 33013431, 33006929, 33000389, 32993811, 32987194, 32980540, 32973847, 32967116, 32960347, 32953540, 32946695, 32939812, 32932891, 32925932, 32918935, 32911899, 32904826, 32897715, 32890566, 32883379, 32876155, 32868892, 32861591, 32854253, 32846877, 32839463, 32832011, 32824521, 32816994, 32809429, 32801826, 32794185, 32786507, 32778791, 32771037, 32763246, 32755417, 32747551, 32739647, 32731705, 32723726, 32715710, 32707655, 32699564, 32691435, 32683268, 32675064, 32666823, 32658544, 32650228, 32641874, 32633484, 32625055, 32616590, 32608087, 32599547, 32590970, 32582356, 32573704, 32565015, 32556289, 32547526, 32538726, 32529889, 32521015, 32512103, 32503155, 32494170, 32485147, 32476088, 32466992, 32457859, 32448688, 32439482, 32430238, 32420957, 32411640, 32402285, 32392894, 32383467, 32374002, 32364501, 32354963, 32345389, 32335777, 32326130, 32316445, 32306724, 32296967, 32287173, 32277342, 32267476, 32257572, 32247632, 32237656, 32227643, 32217595, 32207509, 32197388, 32187230, 32177036, 32166805, 32156539, 32146236, 32135897, 32125522, 32115111, 32104663, 32094180, 32083660, 32073105, 32062514, 32051886, 32041223, 32030524, 32019788, 32009017, 31998211, 31987368, 31976489, 31965575, 31954625, 31943640, 31932618, 31921561, 31910469, 31899340, 31888176, 31876977, 31865742, 31854472, 31843166, 31831824, 31820448, 31809035, 31797588, 31786105, 31774587, 31763033, 31751444, 31739820, 31728161, 31716467, 31704737, 31692972, 31681173, 31669338, 31657468, 31645563, 31633623, 31621648, 31609638, 31597594, 31585514, 31573400, 31561250, 31549066, 31536848, 31524594, 31512306, 31499983, 31487625, 31475233, 31462806, 31450345, 31437849, 31425319, 31412754, 31400155, 31387521, 31374853, 31362151, 31349414, 31336643, 31323838, 31310999, 31298125, 31285217, 31272275, 31259299, 31246289, 31233245, 31220167, 31207054, 31193908, 31180728, 31167514, 31154266, 31140985, 31127669, 31114320, 31100937, 31087520, 31074070, 31060586, 31047068, 31033517, 31019932, 31006314, 30992662, 30978977, 30965259, 30951507, 30937721, 30923903, 30910051, 30896166, 30882247, 30868296, 30854311, 30840293, 30826242, 30812158, 30798041, 30783891, 30769708, 30755492, 30741243, 30726961, 30712647, 30698299, 30683919, 30669507, 30655061, 30640583, 30626072, 30611529, 30596953, 30582345, 30567704, 30553030, 30538324, 30523586, 30508816, 30494013, 30479178, 30464311, 30449411, 30434479, 30419515, 30404520, 30389492, 30374431, 30359339, 30344215, 30329060, 30313872, 30298652, 30283401, 30268117, 30252802, 30237456, 30222077, 30206667, 30191225, 30175752, 30160248, 30144711, 30129144, 30113545, 30097914, 30082252, 30066559, 30050835, 30035079, 30019292, 30003474, 29987625, 29971745, 29955834, 29939891, 29923918, 29907914, 29891879, 29875813, 29859716, 29843589, 29827431, 29811242, 29795022, 29778772, 29762491, 29746179, 29729837, 29713465, 29697062, 29680629, 29664165, 29647671, 29631147, 29614592, 29598008, 29581393, 29564748, 29548073, 29531368, 29514633, 29497867, 29481072, 29464247, 29447393, 29430508, 29413594, 29396649, 29379676, 29362672, 29345639, 29328576, 29311484, 29294363, 29277211, 29260031, 29242821, 29225582, 29208313, 29191015, 29173688, 29156332, 29138947, 29121532, 29104089, 29086616, 29069115, 29051585, 29034025, 29016437, 28998820, 28981175, 28963500, 28945797, 28928066, 28910305, 28892517, 28874699, 28856854, 28838979, 28821077, 28803146, 28785187, 28767199, 28749183, 28731140, 28713068, 28694968, 28676839, 28658683, 28640499, 28622287, 28604047, 28585780, 28567484, 28549161, 28530810, 28512431, 28494025, 28475591, 28457130, 28438641, 28420125, 28401581, 28383010, 28364412, 28345787, 28327134, 28308454, 28289747, 28271013, 28252251, 28233463, 28214648, 28195806, 28176937, 28158041, 28139119, 28120169, 28101193, 28082191, 28063161, 28044106, 28025023, 28005915, 27986779, 27967618, 27948430, 27929216, 27909975, 27890709, 27871416, 27852097, 27832752, 27813381, 27793984, 27774561, 27755112, 27735638, 27716138, 27696611, 27677060, 27657482, 27637879, 27618251, 27598596, 27578917, 27559212, 27539482, 27519726, 27499945, 27480139, 27460307, 27440451, 27420569, 27400663, 27380731, 27360774, 27340793, 27320786, 27300755, 27280699, 27260619, 27240513, 27220383, 27200229, 27180050, 27159846, 27139618, 27119366, 27099089, 27078788, 27058463, 27038114, 27017740, 26997343, 26976921, 26956475, 26936006, 26915512, 26894995, 26874453, 26853888, 26833300, 26812687, 26792051, 26771392, 26750709, 26730002, 26709272, 26688519, 26667742, 26646943, 26626119, 26605273, 26584404, 26563511, 26542596, 26521657, 26500696, 26479711, 26458704, 26437674, 26416622, 26395546, 26374448, 26353328, 26332185, 26311019, 26289831, 26268621, 26247388, 26226133, 26204856, 26183556, 26162235, 26140891, 26119525, 26098138, 26076728, 26055297, 26033843, 26012368, 25990871, 25969353, 25947813, 25926251, 25904668, 25883063, 25861437, 25839789, 25818121, 25796430, 25774719, 25752987, 25731233, 25709458, 25687663, 25665846, 25644008, 25622150, 25600270, 25578370, 25556450, 25534508, 25512546, 25490564, 25468561, 25446537, 25424493, 25402429, 25380344, 25358239, 25336114, 25313969, 25291804, 25269619, 25247413, 25225188, 25202943, 25180678, 25158394, 25136089, 25113765, 25091421, 25069058, 25046675, 25024273, 25001852, 24979411, 24956950, 24934471, 24911972, 24889454, 24866917, 24844361, 24821786, 24799192, 24776580, 24753948, 24731298, 24708629, 24685941, 24663235, 24640510, 24617766, 24595004, 24572224, 24549425, 24526609, 24503773, 24480920, 24458049, 24435159, 24412252, 24389326, 24366383, 24343421, 24320442, 24297446, 24274431, 24251399, 24228349, 24205282, 24182197, 24159095, 24135975, 24112839, 24089684, 24066513, 24043325, 24020119, 23996896, 23973657, 23950400, 23927127, 23903836, 23880529, 23857206, 23833865, 23810508, 23787135, 23763745, 23740338, 23716915, 23693476, 23670021, 23646549, 23623061, 23599557, 23576037, 23552501, 23528949, 23505381, 23481798, 23458198, 23434583, 23410952, 23387306, 23363644, 23339966, 23316273, 23292565, 23268841, 23245102, 23221348, 23197579, 23173794, 23149995, 23126180, 23102351, 23078506, 23054647, 23030773, 23006885, 22982981, 22959064, 22935131, 22911184, 22887223, 22863247, 22839257, 22815253, 22791234, 22767202, 22743155, 22719094, 22695019, 22670930, 22646828, 22622711, 22598581, 22574437, 22550280, 22526109, 22501924, 22477726, 22453515, 22429290, 22405052, 22380800, 22356536, 22332258, 22307967, 22283663, 22259347, 22235017, 22210675, 22186319, 22161951, 22137571, 22113177, 22088771, 22064353, 22039922, 22015479, 21991024, 21966556, 21942076, 21917584, 21893080, 21868563, 21844035, 21819495, 21794943, 21770379, 21745803, 21721216, 21696617, 21672007, 21647385, 21622751, 21598106, 21573450, 21548783, 21524104, 21499414, 21474713, 21450001, 21425278, 21400544, 21375799, 21351043, 21326277, 21301500, 21276712, 21251914, 21227105, 21202285, 21177455, 21152615, 21127765, 21102904, 21078033, 21053152, 21028261, 21003360, 20978449, 20953528, 20928597, 20903657, 20878707, 20853747, 20828778, 20803799, 20778810, 20753812, 20728805, 20703788, 20678763, 20653728, 20628684, 20603631, 20578568, 20553497, 20528417, 20503329, 20478231, 20453125, 20428010, 20402886, 20377754, 20352614, 20327465, 20302308, 20277142, 20251968, 20226786, 20201596, 20176398, 20151192, 20125978, 20100756, 20075526, 20050288, 20025043, 19999790, 19974530, 19949262, 19923986, 19898703, 19873413, 19848116, 19822811, 19797499, 19772180, 19746854, 19721521, 19696181, 19670834, 19645481, 19620120, 19594753, 19569379, 19543999, 19518612, 19493219, 19467819, 19442413, 19417001, 19391583, 19366158, 19340727, 19315291, 19289848, 19264399, 19238945, 19213485, 19188019, 19162547, 19137070, 19111587, 19086099, 19060605, 19035106, 19009601, 18984091, 18958577, 18933057, 18907531, 18882001, 18856466, 18830926, 18805382, 18779832, 18754278, 18728719, 18703155, 18677587, 18652015, 18626438, 18600856, 18575271, 18549681, 18524087, 18498489, 18472887, 18447281, 18421671, 18396057, 18370439, 18344818, 18319192, 18293564, 18267931, 18242295, 18216656, 18191013, 18165367, 18139718, 18114065, 18088410, 18062751, 18037089, 18011425, 17985757, 17960086, 17934413, 17908737, 17883059, 17857377, 17831694, 17806007, 17780319, 17754627, 17728934, 17703239, 17677541, 17651841, 17626139, 17600435, 17574729, 17549021, 17523312, 17497600, 17471887, 17446173, 17420456, 17394739, 17369020, 17343299, 17317577, 17291854, 17266129, 17240404, 17214677, 17188949, 17163221, 17137491, 17111761, 17086030, 17060298, 17034565, 17008832, 16983098, 16957364, 16931629, 16905894, 16880159, 16854424, 16828688, 16802952, 16777216, 16751480, 16725744, 16700008, 16674273, 16648538, 16622803, 16597068, 16571334, 16545600, 16519867, 16494134, 16468402, 16442671, 16416941, 16391211, 16365483, 16339755, 16314028, 16288303, 16262578, 16236855, 16211133, 16185412, 16159693, 16133976, 16108259, 16082545, 16056832, 16031120, 16005411, 15979703, 15953997, 15928293, 15902591, 15876891, 15851193, 15825498, 15799805, 15774113, 15748425, 15722738, 15697055, 15671373, 15645695, 15620019, 15594346, 15568675, 15543007, 15517343, 15491681, 15466022, 15440367, 15414714, 15389065, 15363419, 15337776, 15312137, 15286501, 15260868, 15235240, 15209614, 15183993, 15158375, 15132761, 15107151, 15081545, 15055943, 15030345, 15004751, 14979161, 14953576, 14927994, 14902417, 14876845, 14851277, 14825713, 14800154, 14774600, 14749050, 14723506, 14697966, 14672431, 14646901, 14621375, 14595855, 14570341, 14544831, 14519326, 14493827, 14468333, 14442845, 14417362, 14391885, 14366413, 14340947, 14315487, 14290033, 14264584, 14239141, 14213705, 14188274, 14162849, 14137431, 14112019, 14086613, 14061213, 14035820, 14010433, 13985053, 13959679, 13934312, 13908951, 13883598, 13858251, 13832911, 13807578, 13782252, 13756933, 13731621, 13706316, 13681019, 13655729, 13630446, 13605170, 13579902, 13554642, 13529389, 13504144, 13478906, 13453676, 13428454, 13403240, 13378034, 13352836, 13327646, 13302464, 13277290, 13252124, 13226967, 13201818, 13176678, 13151546, 13126422, 13101307, 13076201, 13051103, 13026015, 13000935, 12975864, 12950801, 12925748, 12900704, 12875669, 12850644, 12825627, 12800620, 12775622, 12750633, 12725654, 12700685, 12675725, 12650775, 12625835, 12600904, 12575983, 12551072, 12526171, 12501280, 12476399, 12451528, 12426667, 12401817, 12376977, 12352147, 12327327, 12302518, 12277720, 12252932, 12228155, 12203389, 12178633, 12153888, 12129154, 12104431, 12079719, 12055018, 12030328, 12005649, 11980982, 11956326, 11931681, 11907047, 11882425, 11857815, 11833216, 11808629, 11784053, 11759489, 11734937, 11710397, 11685869, 11661352, 11636848, 11612356, 11587876, 11563408, 11538953, 11514510, 11490079, 11465661, 11441255, 11416861, 11392481, 11368113, 11343757, 11319415, 11295085, 11270769, 11246465, 11222174, 11197896, 11173632, 11149380, 11125142, 11100917, 11076706, 11052508, 11028323, 11004152, 10979995, 10955851, 10931721, 10907604, 10883502, 10859413, 10835338, 10811277, 10787230, 10763198, 10739179, 10715175, 10691185, 10667209, 10643248, 10619301, 10595368, 10571451, 10547547, 10523659, 10499785, 10475926, 10452081, 10428252, 10404437, 10380638, 10356853, 10333084, 10309330, 10285591, 10261867, 10238159, 10214466, 10190788, 10167126, 10143480, 10119849, 10096234, 10072634, 10049051, 10025483, 10001931, 9978395, 9954875, 9931371, 9907883, 9884411, 9860956, 9837517, 9814094, 9790687, 9767297, 9743924, 9720567, 9697226, 9673903, 9650596, 9627305, 9604032, 9580775, 9557536, 9534313, 9511107, 9487919, 9464748, 9441593, 9418457, 9395337, 9372235, 9349150, 9326083, 9303033, 9280001, 9256986, 9233990, 9211011, 9188049, 9165106, 9142180, 9119273, 9096383, 9073512, 9050659, 9027823, 9005007, 8982208, 8959428, 8936666, 8913922, 8891197, 8868491, 8845803, 8823134, 8800484, 8777852, 8755240, 8732646, 8710071, 8687515, 8664978, 8642460, 8619961, 8597482, 8575021, 8552580, 8530159, 8507757, 8485374, 8463011, 8440667, 8418343, 8396038, 8373754, 8351489, 8329244, 8307019, 8284813, 8262628, 8240463, 8218318, 8196193, 8174088, 8152003, 8129939, 8107895, 8085871, 8063868, 8041886, 8019924, 7997982, 7976062, 7954162, 7932282, 7910424, 7888586, 7866769, 7844974, 7823199, 7801445, 7779713, 7758002, 7736311, 7714643, 7692995, 7671369, 7649764, 7628181, 7606619, 7585079, 7563561, 7542064, 7520589, 7499135, 7477704, 7456294, 7434907, 7413541, 7392197, 7370876, 7349576, 7328299, 7307044, 7285811, 7264601, 7243413, 7222247, 7201104, 7179984, 7158886, 7137810, 7116758, 7095728, 7074721, 7053736, 7032775, 7011836, 6990921, 6970028, 6949159, 6928313, 6907489, 6886690, 6865913, 6845160, 6824430, 6803723, 6783040, 6762381, 6741745, 6721132, 6700544, 6679979, 6659437, 6638920, 6618426, 6597957, 6577511, 6557089, 6536692, 6516318, 6495969, 6475644, 6455343, 6435066, 6414814, 6394586, 6374382, 6354203, 6334049, 6313919, 6293813, 6273733, 6253677, 6233646, 6213639, 6193658, 6173701, 6153769, 6133863, 6113981, 6094125, 6074293, 6054487, 6034706, 6014950, 5995220, 5975515, 5955836, 5936181, 5916553, 5896950, 5877372, 5857821, 5838294, 5818794, 5799320, 5779871, 5760448, 5741051, 5721680, 5702335, 5683016, 5663723, 5644457, 5625216, 5606002, 5586814, 5567653, 5548517, 5529409, 5510326, 5491271, 5472241, 5453239, 5434263, 5415313, 5396391, 5377495, 5358626, 5339784, 5320969, 5302181, 5283419, 5264685, 5245978, 5227298, 5208645, 5190020, 5171422, 5152851, 5134307, 5115791, 5097302, 5078841, 5060407, 5042001, 5023622, 5005271, 4986948, 4968652, 4950385, 4932145, 4913933, 4895749, 4877593, 4859464, 4841364, 4823292, 4805249, 4787233, 4769245, 4751286, 4733355, 4715453, 4697578, 4679733, 4661915, 4644127, 4626366, 4608635, 4590932, 4573257, 4555612, 4537995, 4520407, 4502847, 4485317, 4467816, 4450343, 4432900, 4415485, 4398100, 4380744, 4363417, 4346119, 4328850, 4311611, 4294401, 4277221, 4260069, 4242948, 4225856, 4208793, 4191760, 4174756, 4157783, 4140838, 4123924, 4107039, 4090185, 4073360, 4056565, 4039799, 4023064, 4006359, 3989684, 3973039, 3956424, 3939840, 3923285, 3906761, 3890267, 3873803, 3857370, 3840967, 3824595, 3808253, 3791941, 3775660, 3759410, 3743190, 3727001, 3710843, 3694716, 3678619, 3662553, 3646518, 3630514, 3614541, 3598598, 3582687, 3566807, 3550958, 3535140, 3519353, 3503597, 3487873, 3472180, 3456518, 3440887, 3425288, 3409721, 3394184, 3378680, 3363207, 3347765, 3332355, 3316976, 3301630, 3286315, 3271031, 3255780, 3240560, 3225372, 3210217, 3195093, 3180001, 3164940, 3149912, 3134917, 3119953, 3105021, 3090121, 3075254, 3060419, 3045616, 3030846, 3016108, 3001402, 2986728, 2972087, 2957479, 2942903, 2928360, 2913849, 2899371, 2884925, 2870513, 2856133, 2841785, 2827471, 2813189, 2798940, 2784724, 2770541, 2756391, 2742274, 2728190, 2714139, 2700121, 2686136, 2672185, 2658266, 2644381, 2630529, 2616711, 2602925, 2589173, 2575455, 2561770, 2548118, 2534500, 2520915, 2507364, 2493846, 2480362, 2466912, 2453495, 2440112, 2426763, 2413447, 2400166, 2386918, 2373704, 2360524, 2347378, 2334265, 2321187, 2308143, 2295133, 2282157, 2269215, 2256307, 2243433, 2230594, 2217789, 2205018, 2192281, 2179579, 2166911, 2154277, 2141678, 2129113, 2116583, 2104087, 2091626, 2079199, 2066807, 2054449, 2042126, 2029838, 2017584, 2005366, 1993182, 1981032, 1968918, 1956838, 1944794, 1932784, 1920809, 1908869, 1896964, 1885094, 1873259, 1861460, 1849695, 1837965, 1826271, 1814612, 1802988, 1791399, 1779845, 1768327, 1756844, 1745397, 1733984, 1722608, 1711266, 1699960, 1688690, 1677455, 1666256, 1655092, 1643963, 1632871, 1621814, 1610792, 1599807, 1588857, 1577943, 1567064, 1556221, 1545415, 1534644, 1523908, 1513209, 1502546, 1491918, 1481327, 1470772, 1460252, 1449769, 1439321, 1428910, 1418535, 1408196, 1397893, 1387627, 1377396, 1367202, 1357044, 1346923, 1336837, 1326789, 1316776, 1306800, 1296860, 1286956, 1277090, 1267259, 1257465, 1247708, 1237987, 1228302, 1218655, 1209043, 1199469, 1189931, 1180430, 1170965, 1161538, 1152147, 1142792, 1133475, 1124194, 1114950, 1105744, 1096573, 1087440, 1078344, 1069285, 1060262, 1051277, 1042329, 1033417, 1024543, 1015706, 1006906, 998143, 989417, 980728, 972076, 963462, 954885, 946345, 937842, 929377, 920948, 912558, 904204, 895888, 887609, 879368, 871164, 862997, 854868, 846777, 838722, 830706, 822727, 814785, 806881, 799015, 791186, 783395, 775641, 767925, 760247, 752606, 745003, 737438, 729911, 722421, 714969, 707555, 700179, 692841, 685540, 678277, 671053, 663866, 656717, 649606, 642533, 635497, 628500, 621541, 614620, 607737, 600892, 594085, 587316, 580585, 573892, 567238, 560621, 554043, 547503, 541001, 534537, 528112, 521724, 515375, 509065, 502792, 496558, 490362, 484205, 478085, 472005, 465962, 459958, 453992, 448065, 442176, 436326, 430514, 424740, 419005, 413309, 407651, 402031, 396450, 390908, 385404, 379939, 374512, 369124, 363774, 358463, 353191, 347957, 342762, 337606, 332489, 327410, 322370, 317368, 312405, 307481, 302596, 297750, 292942, 288173, 283443, 278752, 274099, 269485, 264911, 260375, 255878, 251419, 247000, 242620, 238278, 233976, 229712, 225487, 221302, 217155, 213047, 208978, 204948, 200957, 197005, 193092, 189219, 185384, 181588, 177831, 174114, 170435, 166796, 163195, 159634, 156112, 152628, 149184, 145780, 142414, 139087, 135800, 132552, 129342, 126172, 123042, 119950, 116898, 113885, 110911, 107976, 105080, 102224, 99407, 96629, 93891, 91191, 88531, 85911, 83329, 80787, 78284, 75820, 73396, 71011, 68665, 66359, 64092, 61864, 59676, 57527, 55417, 53347, 51316, 49324, 47372, 45459, 43585, 41751, 39956, 38201, 36485, 34808, 33171, 31573, 30014, 28495, 27016, 25576, 24175, 22813, 21491, 20209, 18966, 17762, 16598, 15473, 14388, 13342, 12335, 11369, 10441, 9553, 8704, 7895, 7125, 6395, 5704, 5053, 4441, 3869, 3336, 2842, 2388, 1974, 1599, 1263, 967, 711, 493, 316, 178, 79, 20, 0, 20, 79, 178, 316, 493, 711, 967, 1263, 1599, 1974, 2388, 2842, 3336, 3869, 4441, 5053, 5704, 6395, 7125, 7895, 8704, 9553, 10441, 11369, 12335, 13342, 14388, 15473, 16598, 17762, 18966, 20209, 21491, 22813, 24175, 25576, 27016, 28495, 30014, 31573, 33171, 34808, 36485, 38201, 39956, 41751, 43585, 45459, 47372, 49324, 51316, 53347, 55417, 57527, 59676, 61864, 64092, 66359, 68665, 71011, 73396, 75820, 78284, 80787, 83329, 85911, 88531, 91191, 93891, 96629, 99407, 102224, 105080, 107976, 110911, 113885, 116898, 119950, 123042, 126172, 129342, 132552, 135800, 139087, 142414, 145780, 149184, 152628, 156112, 159634, 163195, 166796, 170435, 174114, 177831, 181588, 185384, 189219, 193092, 197005, 200957, 204948, 208978, 213047, 217155, 221302, 225487, 229712, 233976, 238278, 242620, 247000, 251419, 255878, 260375, 264911, 269485, 274099, 278752, 283443, 288173, 292942, 297750, 302596, 307481, 312405, 317368, 322370, 327410, 332489, 337606, 342762, 347957, 353191, 358463, 363774, 369124, 374512, 379939, 385404, 390908, 396450, 402031, 407651, 413309, 419005, 424740, 430514, 436326, 442176, 448065, 453992, 459958, 465962, 472005, 478085, 484205, 490362, 496558, 502792, 509065, 515375, 521724, 528112, 534537, 541001, 547503, 554043, 560621, 567238, 573892, 580585, 587316, 594085, 600892, 607737, 614620, 621541, 628500, 635497, 642533, 649606, 656717, 663866, 671053, 678277, 685540, 692841, 700179, 707555, 714969, 722421, 729911, 737438, 745003, 752606, 760247, 767925, 775641, 783395, 791186, 799015, 806881, 814785, 822727, 830706, 838722, 846777, 854868, 862997, 871164, 879368, 887609, 895888, 904204, 912558, 920948, 929377, 937842, 946345, 954885, 963462, 972076, 980728, 989417, 998143, 1006906, 1015706, 1024543, 1033417, 1042329, 1051277, 1060262, 1069285, 1078344, 1087440, 1096573, 1105744, 1114950, 1124194, 1133475, 1142792, 1152147, 1161538, 1170965, 1180430, 1189931, 1199469, 1209043, 1218655, 1228302, 1237987, 1247708, 1257465, 1267259, 1277090, 1286956, 1296860, 1306800, 1316776, 1326789, 1336837, 1346923, 1357044, 1367202, 1377396, 1387627, 1397893, 1408196, 1418535, 1428910, 1439321, 1449769, 1460252, 1470772, 1481327, 1491918, 1502546, 1513209, 1523908, 1534644, 1545415, 1556221, 1567064, 1577943, 1588857, 1599807, 1610792, 1621814, 1632871, 1643963, 1655092, 1666256, 1677455, 1688690, 1699960, 1711266, 1722608, 1733984, 1745397, 1756844, 1768327, 1779845, 1791399, 1802988, 1814612, 1826271, 1837965, 1849695, 1861460, 1873259, 1885094, 1896964, 1908869, 1920809, 1932784, 1944794, 1956838, 1968918, 1981032, 1993182, 2005366, 2017584, 2029838, 2042126, 2054449, 2066807, 2079199, 2091626, 2104087, 2116583, 2129113, 2141678, 2154277, 2166911, 2179579, 2192281, 2205018, 2217789, 2230594, 2243433, 2256307, 2269215, 2282157, 2295133, 2308143, 2321187, 2334265, 2347378, 2360524, 2373704, 2386918, 2400166, 2413447, 2426763, 2440112, 2453495, 2466912, 2480362, 2493846, 2507364, 2520915, 2534500, 2548118, 2561770, 2575455, 2589173, 2602925, 2616711, 2630529, 2644381, 2658266, 2672185, 2686136, 2700121, 2714139, 2728190, 2742274, 2756391, 2770541, 2784724, 2798940, 2813189, 2827471, 2841785, 2856133, 2870513, 2884925, 2899371, 2913849, 2928360, 2942903, 2957479, 2972087, 2986728, 3001402, 3016108, 3030846, 3045616, 3060419, 3075254, 3090121, 3105021, 3119953, 3134917, 3149912, 3164940, 3180001, 3195093, 3210217, 3225372, 3240560, 3255780, 3271031, 3286315, 3301630, 3316976, 3332355, 3347765, 3363207, 3378680, 3394184, 3409721, 3425288, 3440887, 3456518, 3472180, 3487873, 3503597, 3519353, 3535140, 3550958, 3566807, 3582687, 3598598, 3614541, 3630514, 3646518, 3662553, 3678619, 3694716, 3710843, 3727001, 3743190, 3759410, 3775660, 3791941, 3808253, 3824595, 3840967, 3857370, 3873803, 3890267, 3906761, 3923285, 3939840, 3956424, 3973039, 3989684, 4006359, 4023064, 4039799, 4056565, 4073360, 4090185, 4107039, 4123924, 4140838, 4157783, 4174756, 4191760, 4208793, 4225856, 4242948, 4260069, 4277221, 4294401, 4311611, 4328850, 4346119, 4363417, 4380744, 4398100, 4415485, 4432900, 4450343, 4467816, 4485317, 4502847, 4520407, 4537995, 4555612, 4573257, 4590932, 4608635, 4626366, 4644127, 4661915, 4679733, 4697578, 4715453, 4733355, 4751286, 4769245, 4787233, 4805249, 4823292, 4841364, 4859464, 4877593, 4895749, 4913933, 4932145, 4950385, 4968652, 4986948, 5005271, 5023622, 5042001, 5060407, 5078841, 5097302, 5115791, 5134307, 5152851, 5171422, 5190020, 5208645, 5227298, 5245978, 5264685, 5283419, 5302181, 5320969, 5339784, 5358626, 5377495, 5396391, 5415313, 5434263, 5453239, 5472241, 5491271, 5510326, 5529409, 5548517, 5567653, 5586814, 5606002, 5625216, 5644457, 5663723, 5683016, 5702335, 5721680, 5741051, 5760448, 5779871, 5799320, 5818794, 5838294, 5857821, 5877372, 5896950, 5916553, 5936181, 5955836, 5975515, 5995220, 6014950, 6034706, 6054487, 6074293, 6094125, 6113981, 6133863, 6153769, 6173701, 6193658, 6213639, 6233646, 6253677, 6273733, 6293813, 6313919, 6334049, 6354203, 6374382, 6394586, 6414814, 6435066, 6455343, 6475644, 6495969, 6516318, 6536692, 6557089, 6577511, 6597957, 6618426, 6638920, 6659437, 6679979, 6700544, 6721132, 6741745, 6762381, 6783040, 6803723, 6824430, 6845160, 6865913, 6886690, 6907489, 6928313, 6949159, 6970028, 6990921, 7011836, 7032775, 7053736, 7074721, 7095728, 7116758, 7137810, 7158886, 7179984, 7201104, 7222247, 7243413, 7264601, 7285811, 7307044, 7328299, 7349576, 7370876, 7392197, 7413541, 7434907, 7456294, 7477704, 7499135, 7520589, 7542064, 7563561, 7585079, 7606619, 7628181, 7649764, 7671369, 7692995, 7714643, 7736311, 7758002, 7779713, 7801445, 7823199, 7844974, 7866769, 7888586, 7910424, 7932282, 7954162, 7976062, 7997982, 8019924, 8041886, 8063868, 8085871, 8107895, 8129939, 8152003, 8174088, 8196193, 8218318, 8240463, 8262628, 8284813, 8307019, 8329244, 8351489, 8373754, 8396038, 8418343, 8440667, 8463011, 8485374, 8507757, 8530159, 8552580, 8575021, 8597482, 8619961, 8642460, 8664978, 8687515, 8710071, 8732646, 8755240, 8777852, 8800484, 8823134, 8845803, 8868491, 8891197, 8913922, 8936666, 8959428, 8982208, 9005007, 9027823, 9050659, 9073512, 9096383, 9119273, 9142180, 9165106, 9188049, 9211011, 9233990, 9256986, 9280001, 9303033, 9326083, 9349150, 9372235, 9395337, 9418457, 9441593, 9464748, 9487919, 9511107, 9534313, 9557536, 9580775, 9604032, 9627305, 9650596, 9673903, 9697226, 9720567, 9743924, 9767297, 9790687, 9814094, 9837517, 9860956, 9884411, 9907883, 9931371, 9954875, 9978395, 10001931, 10025483, 10049051, 10072634, 10096234, 10119849, 10143480, 10167126, 10190788, 10214466, 10238159, 10261867, 10285591, 10309330, 10333084, 10356853, 10380638, 10404437, 10428252, 10452081, 10475926, 10499785, 10523659, 10547547, 10571451, 10595368, 10619301, 10643248, 10667209, 10691185, 10715175, 10739179, 10763198, 10787230, 10811277, 10835338, 10859413, 10883502, 10907604, 10931721, 10955851, 10979995, 11004152, 11028323, 11052508, 11076706, 11100917, 11125142, 11149380, 11173632, 11197896, 11222174, 11246465, 11270769, 11295085, 11319415, 11343757, 11368113, 11392481, 11416861, 11441255, 11465661, 11490079, 11514510, 11538953, 11563408, 11587876, 11612356, 11636848, 11661352, 11685869, 11710397, 11734937, 11759489, 11784053, 11808629, 11833216, 11857815, 11882425, 11907047, 11931681, 11956326, 11980982, 12005649, 12030328, 12055018, 12079719, 12104431, 12129154, 12153888, 12178633, 12203389, 12228155, 12252932, 12277720, 12302518, 12327327, 12352147, 12376977, 12401817, 12426667, 12451528, 12476399, 12501280, 12526171, 12551072, 12575983, 12600904, 12625835, 12650775, 12675725, 12700685, 12725654, 12750633, 12775622, 12800620, 12825627, 12850644, 12875669, 12900704, 12925748, 12950801, 12975864, 13000935, 13026015, 13051103, 13076201, 13101307, 13126422, 13151546, 13176678, 13201818, 13226967, 13252124, 13277290, 13302464, 13327646, 13352836, 13378034, 13403240, 13428454, 13453676, 13478906, 13504144, 13529389, 13554642, 13579902, 13605170, 13630446, 13655729, 13681019, 13706316, 13731621, 13756933, 13782252, 13807578, 13832911, 13858251, 13883598, 13908951, 13934312, 13959679, 13985053, 14010433, 14035820, 14061213, 14086613, 14112019, 14137431, 14162849, 14188274, 14213705, 14239141, 14264584, 14290033, 14315487, 14340947, 14366413, 14391885, 14417362, 14442845, 14468333, 14493827, 14519326, 14544831, 14570341, 14595855, 14621375, 14646901, 14672431, 14697966, 14723506, 14749050, 14774600, 14800154, 14825713, 14851277, 14876845, 14902417, 14927994, 14953576, 14979161, 15004751, 15030345, 15055943, 15081545, 15107151, 15132761, 15158375, 15183993, 15209614, 15235240, 15260868, 15286501, 15312137, 15337776, 15363419, 15389065, 15414714, 15440367, 15466022, 15491681, 15517343, 15543007, 15568675, 15594346, 15620019, 15645695, 15671373, 15697055, 15722738, 15748425, 15774113, 15799805, 15825498, 15851193, 15876891, 15902591, 15928293, 15953997, 15979703, 16005411, 16031120, 16056832, 16082545, 16108259, 16133976, 16159693, 16185412, 16211133, 16236855, 16262578, 16288303, 16314028, 16339755, 16365483, 16391211, 16416941, 16442671, 16468402, 16494134, 16519867, 16545600, 16571334, 16597068, 16622803, 16648538, 16674273, 16700008, 16725744, 16751480};
  volatile uint32_t currentStepSize;


  //ADSR
  volatile uint8_t A = 2;
  volatile uint8_t D = 1;
  volatile uint8_t S = 1;
  volatile uint8_t R = 1;
  volatile uint8_t S_amp = 204;

  //LFO
  volatile uint8_t vibrato = 0; //Ints from [0, 20]
  volatile uint8_t tremolo = 0; //Ints from [0, 20]

//Display driver object
U8G2_SSD1305_128X32_NONAME_F_HW_I2C u8g2(U8G2_R0);

//Function to set outputs using key matrix
void setOutMuxBit(const uint8_t bitIdx, const bool value) {
      digitalWrite(REN_PIN,LOW);
      digitalWrite(RA0_PIN, bitIdx & 0x01);
      digitalWrite(RA1_PIN, bitIdx & 0x02);
      digitalWrite(RA2_PIN, bitIdx & 0x04);
      digitalWrite(OUT_PIN,value);
      digitalWrite(REN_PIN,HIGH);
      delayMicroseconds(2);
      digitalWrite(REN_PIN,LOW);
}

void setRow(uint8_t rowIdx){
    digitalWrite(REN_PIN,LOW);
    digitalWrite(RA0_PIN, rowIdx & 0x01);
    digitalWrite(RA1_PIN, rowIdx & 0x02);
    digitalWrite(RA2_PIN, rowIdx & 0x04);
    digitalWrite(REN_PIN,HIGH);
}

uint8_t readCols(){
    // digitalWrite(RA0_PIN, LOW);
    // digitalWrite(RA1_PIN, LOW);
    // digitalWrite(RA2_PIN, LOW);
    // digitalWrite(REN_PIN,HIGH);
    uint8_t c0 = digitalRead(C0_PIN);
    uint8_t c1 = digitalRead(C1_PIN);
    uint8_t c2 = digitalRead(C2_PIN);
    uint8_t c3 = digitalRead(C3_PIN);
    return c3 << 3 | c2 << 2 | c1 << 1 | c0;
}


uint32_t ADSR(uint32_t t){
    
    static uint32_t scale = 0;
    
    if (t == 0)
        scale = 0;
        
    else if (t < ((A*9 * 22000) >> 8)) //Attack envelope
        scale += 84*(256/A);
        
    else if (t == ((A*9 * 22000) >> 8)) //Attack peak
        scale = 16777215;
        
    else if (t < (((A*9 + D*76)*22000) >> 8)) //Decay envelope
        scale -= (16777216 - (S_amp << 16))/(22000*76) * (256/D);
        
    else if (t < (((A*9 + D*76 + S*46)*22000) >> 8)) //Sustain envelope
        scale = S_amp << 16;
        
    else if (t < (((A*9 + D*76 + S*46 + R*60)*22000) >> 8)) //Release envelope
        scale -= (S_amp << 16)/(22000*60) * (256/R);
        
    else
        scale = 0;
    
    return scale;

}

uint32_t LFOVibrato(uint32_t t) {
    uint32_t index = ((t*4096*vibrato)/22000) % 4096;
  
    return LFOTable[index];
}

uint32_t LFOTremolo(uint32_t t) {
    uint32_t index = ((t*4096*tremolo)/22000) % 4096;
  
    return LFOTable[index];
}



void sampleISR() {

  static uint32_t phaseAcc = 0;
  static uint32_t time = 0;
  
  if (wave_select == 0) { //Sawtooth
    
    phaseAcc += currentStepSize;
    int32_t scaled_phaseAcc = ((phaseAcc >> 24)*ADSR(time));
    time += 1;
    int32_t Vout = (scaled_phaseAcc >> 24) >> 4;


    analogWrite(OUTR_PIN, Vout);
  }
  else if (wave_select == 1){ //Triangle
    if (increase == 1) {
      if ((phaseAcc + 2*currentStepSize) >= phaseAcc){
        phaseAcc += 2*currentStepSize;
      }
      else{
        phaseAcc -= 1;
        increase = -1;
      }
    }
    else {
      if ((phaseAcc - 2*currentStepSize) <= phaseAcc){
        phaseAcc -= 2*currentStepSize;
      }
      else{
        phaseAcc += 1;
        increase = 1;
      }
    }
    int32_t Vout = (phaseAcc >> 24) - 128;
    analogWrite(OUTR_PIN, Vout + 128);

  }
  else if (wave_select == 2) { //Square
    if (increase == 1) {
      if ((phaseAcc + 2*currentStepSize) >= phaseAcc){
        phaseAcc += 2*currentStepSize;
      }
      else{
        phaseAcc -= 1;
        increase = -1;
      }

    }
    else {
      if ((phaseAcc - 2*currentStepSize) <= phaseAcc){
        phaseAcc -= 2*currentStepSize;
      }
      else{
        phaseAcc += 1;
        increase = 1;
      }
      
    } 

    int32_t Vout = (phaseAcc == 0) ? 0 : (increase == 1) ? 127 : (increase == 1) ? -128 : 0;


    analogWrite(OUTR_PIN, Vout + 128);
    
  }
  else {
    phaseAcc += currentStepSize;
    int32_t scaled_phaseAcc = ((sineTable[phaseAcc >> 22]  >> 24)*ADSR(time));
    time += 1;
    int32_t Vout = (scaled_phaseAcc >> 24) >> 4;

    analogWrite(OUTR_PIN, Vout + 128);
  }

}


void setup() {
  // put your setup code here, to run once:
  //Hardware Timer
  TIM_TypeDef *Instance = TIM1;
  HardwareTimer *sampleTimer = new HardwareTimer(Instance);

  sampleTimer->setOverflow(22000, HERTZ_FORMAT);
  sampleTimer->attachInterrupt(sampleISR);
  sampleTimer->resume();

  //Set pin directions
  pinMode(RA0_PIN, OUTPUT);
  pinMode(RA1_PIN, OUTPUT);
  pinMode(RA2_PIN, OUTPUT);
  pinMode(REN_PIN, OUTPUT);
  pinMode(OUT_PIN, OUTPUT);
  pinMode(OUTL_PIN, OUTPUT);
  pinMode(OUTR_PIN, OUTPUT);
  pinMode(LED_BUILTIN, OUTPUT);

  pinMode(C0_PIN, INPUT);
  pinMode(C1_PIN, INPUT);
  pinMode(C2_PIN, INPUT);
  pinMode(C3_PIN, INPUT);
  pinMode(JOYX_PIN, INPUT);
  pinMode(JOYY_PIN, INPUT);

  //Initialise display
  setOutMuxBit(DRST_BIT, LOW);  //Assert display logic reset
  delayMicroseconds(2);
  setOutMuxBit(DRST_BIT, HIGH);  //Release display logic reset
  u8g2.begin();
  setOutMuxBit(DEN_BIT, HIGH);  //Enable display power supply


  //Initialise UART
  Serial.begin(9600);
  Serial.println("Hello World");
}

void loop() {
  // put your main code here, to run repeatedly:
  static uint32_t next = millis();
  static uint32_t count = 0;
  uint8_t keyArray[7];

  while (millis() < next);  //Wait for next interval

  next += interval;

  
  //Update display
  u8g2.clearBuffer();         // clear the internal memory
  u8g2.setCursor(2,20);
  u8g2.setFont(u8g2_font_ncenB08_tr); // choose a suitable font
  uint32_t localCurrentStepSize = 0;
  uint32_t increase = 0;
  for (uint8_t i = 0; i < 3; i++){
    setRow(i);
    delayMicroseconds(3);
    uint8_t keys = readCols();  
    keyArray[i] = keys;    
    u8g2.print(keyArray[i],HEX);

    uint8_t onehot = keys ^ 0xF;
    for(int j = 0; j<4; j++){
        uint8_t idx = 4*i + j;
        if (onehot & (1<<j)){
            localCurrentStepSize = stepSizes[idx];
        }
    }

  }
  __atomic_store_n(&currentStepSize, localCurrentStepSize, __ATOMIC_RELAXED);

  
  u8g2.sendBuffer();          // transfer internal memory to the display

  //Toggle LED
  digitalToggle(LED_BUILTIN);
  
}